flowchart TD
  %% =========  CLIENTâ€‘SIDE (Jinjaâ€‘rendered HTML) =========
  subgraph Browser
      direction LR
      LoginPage["/login  â–¸  username / password form"]
      StocksPage["/stocks  â–¸  table:<br/>ticker Â· shares Â· avg_price_paid Â· cost_basis Â· current_price Â· last_updated Â· [ğŸ–ŠÂ Update]Â [â•Â Add]Â [ğŸ—‘ï¸Â Softâ€‘Delete]"]
      OptionsPage["/options  â–¸  table:<br/>ticker Â· option_ticker Â· qty Â· exp_date Â· avg_price Â· cost_basis Â· greeksâ€¦ Â· [ğŸ–Š]Â [â•]Â [ğŸ—‘ï¸] <br/>â†³Â JS opensÂ <code>ws://â€¦/ws/options</code> for live prices"]
      RiskPage["/risk  â–¸  table:<br/>ticker Â· min_prob_OTM Â· max_prob_OTM Â· min_rorc Â· last_updated Â· [ğŸ–Š]Â [â•]Â [ğŸ—‘ï¸]"]
      StockForm["/stocks/newÂ |Â /stocks/{ticker}/edit  â–¸  HTMLÂ form"]
      OptionForm["/options/newÂ |Â /options/{opt_tkr}/editÂ â–¸  HTMLÂ form"]
      RiskForm["/risk/newÂ |Â /risk/{ticker}/edit â–¸  HTMLÂ form"]
  end

  %% =========  ROUTES (FastAPI) =========
  subgraph FastAPIÂ (ASGI server)
      direction TB
      route_login["POST /login<br/><small>check creds âœ create session cookie</small>"]
      route_get_stocks["GET /stocks"]
      route_post_stock["POST /stocks       <br/><small>INSERT</small>"]
      route_put_stock["POST /stocks/{ticker}<br/><small>UPDATE / softâ€‘delete</small>"]
      route_ws_options["WEBSOCKET /ws/options<br/><small>push JSON price ticks</small>"]

      route_get_opts["GET /options"]
      route_post_opt["POST /options"]
      route_put_opt["POST /options/{option_ticker}"]

      route_get_risk["GET /risk"]
      route_post_risk["POST /risk"]
      route_put_risk["POST /risk/{ticker}"]
  end

  %% =========  PERSISTENCE LAYER =========
  subgraph PostgreSQL
      tbl_users[(users<br/>id PK Â· username Â· pass_hash Â· is_active)]
      tbl_stocks[(stocks<br/>ticker PK Â· shares Â· avg_price_paid Â· cost_basis Â· current_price Â· last_updated Â· is_active BOOL)]
      tbl_options[(options<br/>option_ticker PK Â· ticker FK â†’ stocks.ticker Â· quantity Â· expiration_date Â· avg_price Â· cost_basis Â· greeksâ€¦ Â· last_updated Â· is_active BOOL)]
      tbl_risk[(risk_profile_call<br/>ticker PK FK â†’ stocks.ticker Â· min_prob_OTM Â· max_prob_OTM Â· min_rorc Â· last_updated Â· is_active BOOL)]
  end

  %% =========  DATA FLOW =========
  %% authentication
  LoginPage --> route_login --> tbl_users
  %% read pages
  StocksPage  --> route_get_stocks
  OptionsPage --> route_get_opts
  RiskPage    --> route_get_risk
  %% add / update / softâ€‘delete
  StocksPage -- [â•] --> StockForm --> route_post_stock --> tbl_stocks
  StocksPage -- [ğŸ–Š] --> StockForm --> route_put_stock  --> tbl_stocks
  StocksPage -- [ğŸ—‘ï¸] --> route_put_stock              --> tbl_stocks
  OptionsPage -- [â•] --> OptionForm --> route_post_opt --> tbl_options
  OptionsPage -- [ğŸ–Š] --> OptionForm --> route_put_opt  --> tbl_options
  OptionsPage -- [ğŸ—‘ï¸] --> route_put_opt               --> tbl_options
  RiskPage   -- [â•] --> RiskForm   --> route_post_risk --> tbl_risk
  RiskPage   -- [ğŸ–Š] --> RiskForm   --> route_put_risk  --> tbl_risk
  RiskPage   -- [ğŸ—‘ï¸] --> route_put_risk               --> tbl_risk
  %% websocket
  OptionsPage -- open WS --> route_ws_options
  route_ws_options --> tbl_options   %% (reads for context)

